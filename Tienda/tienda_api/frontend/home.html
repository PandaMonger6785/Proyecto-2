{% extends "base.html" %}
{% load static %}

{% block title %}Inicio - PandaExpress{% endblock %}

{% block content %}
  <section class="hero-simple" id="ofertas">
    <div class="hero-inner">
      <h2>Descubre nuestras ofertas destacadas</h2>
      <p>Productos con envío rápido, garantía extendida y promociones cada semana.</p>
    </div>
  </section>

  <div class="toolbar">
    <div class="search"><input type="search" id="q" placeholder="Buscar productos..." aria-label="Buscar productos"></div>
    <div class="toolbar-actions">
      <button class="btn btn-secondary btn-small" type="button" id="btnReload">Recargar catálogo</button>
      <button class="btn btn-ghost btn-small" type="button" data-show-modal="promo">Ver promociones</button>
    </div>
  </div>

  <div class="tabs" role="tablist" aria-label="Filtro principal">
    <button class="tab" aria-selected="true" role="tab" data-category="">Todos</button>
    <button class="tab" role="tab" data-category="ofertas">Ofertas</button>
  </div>

  <main class="tab-panel">
    <div id="grid" class="grid-products" aria-live="polite">
      <p class="meta">Cargando productos...</p>
    </div>
  </main>

  <div id="detailsModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="1"></div>
    <article class="modal-card" role="dialog" aria-modal="true" aria-labelledby="detTitle">
      <header class="modal-header">
        <h3 id="detTitle">Detalle del producto</h3>
        <button class="btn btn-ghost" type="button" data-close="1">Cerrar</button>
      </header>
      <div class="modal-body column">
        <img id="detImg" class="modal-img" src="{% static 'img/placeholder.png' %}" alt="Producto">
        <div class="modal-info">
          <h4 id="detName"></h4>
          <p class="meta" id="detMeta"></p>
          <p id="detDesc"></p>
          <strong id="detPrice"></strong>
        </div>
      </div>
    </article>
  </div>

  <div id="qtyModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="1"></div>
    <article class="modal-card" role="dialog" aria-modal="true" aria-labelledby="qtyTitle">
      <header class="modal-header">
        <h3 id="qtyTitle">Agregar al carrito</h3>
        <button class="btn btn-ghost" type="button" data-close="1">Cerrar</button>
      </header>
      <div class="modal-body column">
        <p class="cm-name" id="cmName"></p>
        <div class="cm-row">
          <label for="cmQty">Cantidad</label>
          <input id="cmQty" type="number" min="1" value="1">
        </div>
        <div class="cm-row">
          <label>Precio unitario</label>
          <strong id="cmUnit">$0.00</strong>
        </div>
        <div class="cm-row total">
          <label>Total</label>
          <strong id="cmTotal">$0.00</strong>
        </div>
        <div class="cm-actions">
          <button class="btn btn-ghost" type="button" data-close="1">Cancelar</button>
          <button class="btn btn-primary" type="button" id="cmConfirm">Agregar</button>
        </div>
      </div>
    </article>
  </div>
{% endblock %}

{% block extra_js %}
  {% url 'tienda:product-list' as product_list_url %}
  {% url 'tienda:category-list' as category_list_url %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const PRODUCTS_API = "{{ product_list_url }}";
      const CATEGORIES_API = "{{ category_list_url }}";

      const grid = document.getElementById('grid');
      const navSearch = document.getElementById('globalSearch');
      const pageSearch = document.getElementById('q');
      const reloadBtn = document.getElementById('btnReload');
      const catMenu = document.getElementById('catsMenu');
      const catDropdown = document.getElementById('catDropdown');
      const catList = document.getElementById('catList');
      const detailsModal = document.getElementById('detailsModal');
      const qtyModal = document.getElementById('qtyModal');
      const qtyInput = document.getElementById('cmQty');
      const qtyName = document.getElementById('cmName');
      const qtyUnit = document.getElementById('cmUnit');
      const qtyTotal = document.getElementById('cmTotal');
      const qtyConfirm = document.getElementById('cmConfirm');
      const detTitle = document.getElementById('detTitle');
      const detImg = document.getElementById('detImg');
      const detDesc = document.getElementById('detDesc');
      const detPrice = document.getElementById('detPrice');
      const detMeta = document.getElementById('detMeta');
      const detName = document.getElementById('detName');

      const money = (n) => Number(n || 0).toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });
      const PLACEHOLDER = "{% static 'img/placeholder.png' %}";

      let products = [];
      let activeCategory = '';
      let searchTerm = '';
      let currentProduct = null;

      function openModal(modal){
        if(!modal) return;
        modal.classList.remove('hidden');
        modal.setAttribute('aria-hidden', 'false');
      }
      function closeModal(modal){
        if(!modal) return;
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
      }

      function renderProducts(list){
        if(!grid) return;
        if(!list.length){
          grid.innerHTML = '<p class="meta">No se encontraron productos con los filtros seleccionados.</p>';
          return;
        }
         grid.innerHTML = list.map(prod => `
          <article class="card" data-id="${prod.id}">
            <img src="${prod.image || PLACEHOLDER}" alt="${prod.name}">
            <span class="badge">${prod.category_name || 'Sin categoría'}</span>
            <h3>${prod.name}</h3>
            <div class="price">${money(prod.price)}</div>
            <div class="actions">
              <button class="btn btn-ghost btn-small" data-action="details" data-id="${prod.id}">Ver detalles</button>
              <button class="btn btn-primary btn-small" data-action="add" data-id="${prod.id}">Agregar</button>
            </div>
          </article>
        `).join('');
      }

      function applyFilters(){
        let list = [...products];
        if(activeCategory){
          if(activeCategory === 'ofertas'){
            list = list.filter(item => (item.category_name || '').toLowerCase().includes('oferta'));
          }else{
            list = list.filter(item => String(item.category) === String(activeCategory));
          }
        }
        if(searchTerm){
          list = list.filter(item => {
            const text = `${item.name} ${item.description || ''} ${item.category_name || ''}`.toLowerCase();
            return text.includes(searchTerm);
          });
        }
        renderProducts(list);
      }

      function setActiveCategory(value){
        activeCategory = value || '';
        document.querySelectorAll('.tab').forEach(tab => {
          tab.setAttribute('aria-selected', tab.dataset.category === activeCategory ? 'true' : 'false');
        });
        if(catDropdown){
          catDropdown.querySelectorAll('[data-cat]').forEach(btn => {
            if((btn.dataset.cat || '') === activeCategory){
              btn.classList.add('active');
            }else{
              btn.classList.remove('active');
            }
          });
        }
        applyFilters();
      }

      function setSearchTerm(value, source){
        const text = (value || '').trim();
        searchTerm = text.toLowerCase();
        if(source !== 'page' && pageSearch && pageSearch.value !== text){
          pageSearch.value = text;
        }
        if(source !== 'nav' && navSearch && navSearch.value !== text){
          navSearch.value = text;
        }
        applyFilters();
      }

      async function loadProducts(){
        if(grid){
          grid.innerHTML = '<p class="meta">Cargando productos...</p>';
        }
        try{
          const res = await fetch(PRODUCTS_API, { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' });
          if(!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          products = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);
          products = products.map(item => ({
            ...item,
            image: item.image || null
          }));
          applyFilters();
        }catch(err){
          console.error('Error cargando productos', err);
          if(grid){
            grid.innerHTML = '<p class="meta">No fue posible cargar los productos. Intenta nuevamente.</p>';
          }
          window.pushToast?.('No se pudieron cargar los productos.', 'danger');
        }
      }

      async function loadCategories(){
        if(!catList) return;
        try{
          const res = await fetch(CATEGORIES_API, { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' });
          if(!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          const categories = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);
          catList.innerHTML = categories.map(cat => `
            <button class="dropdown-action" type="button" data-cat="${cat.id}">${cat.name}</button>
          `).join('');
        }catch(err){
          console.error('Error cargando categorías', err);
          catList.innerHTML = '<div class="meta">No se pudieron cargar las categorías.</div>';
        }
      }

      function showDetails(product){
        if(!detailsModal) return;
        detTitle.textContent = product.name;
        if(detName) detName.textContent = product.name;
        detImg.src = product.image || PLACEHOLDER;
        detImg.alt = product.name;
        detDesc.textContent = product.description || 'Sin descripción disponible.';
        detMeta.textContent = product.category_name ? `Categoría: ${product.category_name}` : 'Sin categoría';
        detPrice.textContent = money(product.price);
        openModal(detailsModal);
      }

      function showQuantity(product){
        if(!qtyModal) return;
        currentProduct = product;
        qtyName.textContent = product.name;
        qtyUnit.textContent = money(product.price);
        qtyInput.value = 1;
        qtyTotal.textContent = money(product.price);
        openModal(qtyModal);
      }

      if(qtyInput){
        qtyInput.addEventListener('input', () => {
          const value = Math.max(1, Number(qtyInput.value) || 1);
          qtyInput.value = value;
          if(currentProduct){
            qtyTotal.textContent = money(currentProduct.price * value);
          }
        });
      }

      if(qtyConfirm){
        qtyConfirm.addEventListener('click', () => {
          if(!currentProduct) return;
          const quantity = Math.max(1, Number(qtyInput.value) || 1);
          window.CartManager?.add({
            id: currentProduct.id,
            name: currentProduct.name,
            price: Number(currentProduct.price),
            quantity
          });
          closeModal(qtyModal);
        });
      }

      grid?.addEventListener('click', (e) => {
        const id = Number(e.target.dataset.id);
        if(!id) return;
        const product = products.find(item => item.id === id);
        if(!product) return;
        if(e.target.dataset.action === 'details'){
          showDetails(product);
        }else if(e.target.dataset.action === 'add'){
          showQuantity(product);
        }
      });

      detailsModal?.addEventListener('click', (e) => {
        if(e.target.dataset.close || e.target.classList.contains('modal-backdrop')){
          closeModal(detailsModal);
        }
      });
      qtyModal?.addEventListener('click', (e) => {
        if(e.target.dataset.close || e.target.classList.contains('modal-backdrop')){
          closeModal(qtyModal);
        }
      });
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape'){
          closeModal(detailsModal);
          closeModal(qtyModal);
        }
      });

      catDropdown?.addEventListener('click', (e) => {
        if(e.target.dataset.cat !== undefined){
          setActiveCategory(e.target.dataset.cat);
          catMenu?.classList.remove('open');
        }
      });

      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(btn => btn.setAttribute('aria-selected', 'false'));
          tab.setAttribute('aria-selected', 'true');
          setActiveCategory(tab.dataset.category || '');
        });
      });

      navSearch?.addEventListener('input', (e) => setSearchTerm(e.target.value, 'nav'));
      pageSearch?.addEventListener('input', (e) => setSearchTerm(e.target.value, 'page'));

      reloadBtn?.addEventListener('click', () => {
        loadProducts();
        loadCategories();
      });

      loadProducts();
      loadCategories();
    });
  </script>
{% endblock %}