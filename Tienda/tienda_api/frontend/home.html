{% extends "base.html" %}
{% load static %}

{% block title %}Inicio - Tienda{% endblock %}

{% block content %}
  <section class="hero-simple">
    <div class="hero-inner">
      <h2>Descubre nuestras ofertas</h2>
      <p>Productos con envío rápido y garantía.</p>
    </div>
  </section>

  <div class="tabs" role="tablist" aria-label="categorías">
    <button class="tab" aria-selected="true" role="tab" data-category="">Todos</button>
    <button class="tab" role="tab" data-category="Ofertas">Ofertas</button>
  </div>

  <div id="catChips" style="max-width:1400px;margin:10px auto 0;padding:0 12px;display:flex;gap:8px;flex-wrap:wrap"></div>

  <section class="tab-panel">
    <div id="grid" class="grid-products" aria-live="polite"></div>
  </section>

  <!-- Modal: Detalles -->
  <div id="detailsModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="1"></div>
    <article class="modal-card" role="dialog" aria-modal="true" aria-labelledby="detTitle">
      <header style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px">
        <h3 id="detTitle" style="margin:0">Detalles del producto</h3>
        <button class="btn btn-ghost" data-close="1">Cerrar</button>
      </header>
      <div style="display:grid;grid-template-columns:minmax(260px,340px) 1fr;gap:16px;align-items:start">
        <img id="detImg" src="{% static 'img/placeholder.png' %}" alt="Imagen"
             style="width:100%;height:280px;object-fit:cover;border-radius:12px;background:#f3f3f3">
        <div>
          <h4 id="detName" style="margin:0 0 4px"></h4>
          <div id="detPrice" class="price"></div>
          <div id="detMeta" style="color:#6b7280;margin:6px 0 12px"></div>
          <p id="detDesc" style="white-space:pre-wrap;margin:0;max-height:48vh;overflow:auto"></p>
        </div>
      </div>
    </article>
  </div>

  <!-- Modal: Cantidad -->
  <div id="qtyModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="1"></div>
    <article class="modal-card" role="dialog" aria-modal="true" aria-labelledby="qtyTitle">
      <h3 id="qtyTitle" style="margin:0 0 8px">Agregar al carrito</h3>
      <p class="cm-name" id="cmName"></p>
      <div class="cm-row"><label for="cmQty">Cantidad</label><input id="cmQty" type="number" min="1" value="1"></div>
      <div class="cm-row"><label>Precio unitario</label><strong id="cmUnit">$0.00</strong></div>
      <div class="cm-row total"><label>Total</label><strong id="cmTotal">$0.00</strong></div>
      <div class="cm-actions">
        <button class="btn btn-ghost" data-close="1">Cancelar</button>
        <button class="btn btn-primary" id="cmConfirm">Agregar</button>
      </div>
    </article>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  // API del router DRF
  window.PRODUCTS_API = "/api/products/?format=json";

  // Placeholder embebido (no depende de static):
  const PLACEHOLDER = 'data:image/svg+xml;utf8,' +
    encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="600" height="380">
      <rect width="100%" height="100%" fill="#f3f4f6"/>
      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
            font-family="Segoe UI, Arial" font-size="18" fill="#9ca3af">
        Imagen no disponible
      </text>
    </svg>`);

  const money = n => Number(n||0).toLocaleString('es-MX',{style:'currency',currency:'MXN'});

  let products = [];
  let currentCategory = '';

  function showStatus(msg){
    const grid = $('#grid');
    if (grid) grid.innerHTML = `<article class="card" style="grid-column:1/-1">${msg}</article>`;
  }

  async function loadProducts(){
    try{
      showStatus('Cargando…');

      const res = await fetch(window.PRODUCTS_API, {
        headers: { 'Accept':'application/json' },
        credentials: 'same-origin'
      });

      const text = await res.text();
      console.log("GET", window.PRODUCTS_API, res.status);

      if (text.trim().startsWith('<')) {
        console.error('Respuesta HTML de la API (¿redirige a login?)');
        showStatus(`No se pudieron cargar los productos (HTML). Abre <code>${window.PRODUCTS_API}</code> en otra pestaña.`);
        return;
      }

      const data = JSON.parse(text);
      const rows = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);
      console.log("Productos recibidos:", rows.length);

      products = rows.map(p => ({
        id: p.id,
        name: p.name || p.nombre || 'Producto',
        price: Number(p.price ?? p.precio ?? 0),
        description: p.description || p.descripcion || '',
        category_name: p.category_name || p.categoria || (p.category?.name || p.category?.nombre) || '',
        stock: p.stock ?? 0,
        image: p.image || p.imagen || ''   // si viene vacío, usamos PLACEHOLDER en render
      }));

      renderCategoryChips();
      render(products);
    }catch(err){
      console.error("Error cargando productos:", err);
      showStatus('Error cargando productos. Revisa la consola (F12).');
    }
  }

  function render(list){
    const grid = $('#grid');
    if (!grid) return;

    if (!list.length){
      showStatus('No hay productos disponibles. Verifica que existan y que <code>is_active=True</code>.');
      return;
    }

    grid.innerHTML = list.map(p => `
      <article class="card" data-id="${p.id}">
        <span class="badge">${p.category_name || 'General'}</span>
        <img src="${p.image || PLACEHOLDER}" alt="${p.name}"
             onerror="this.onerror=null;this.src='${PLACEHOLDER}'">
        <h3>${p.name}</h3>
        <div class="price">${money(p.price)}</div>
        <div class="actions">
          <button class="btn btn-primary" data-add="${p.id}">Agregar</button>
          <button class="btn btn-ghost" data-det="${p.id}">Detalles</button>
        </div>
      </article>
    `).join('');
  }

  function renderCategoryChips(){
    const box = $('#catChips');
    if(!box) return;
    const cats = [...new Set(products.map(x => (x.category_name||'').trim()).filter(Boolean))].sort();
    box.innerHTML = cats.map(c =>
      `<button class="btn btn-ghost btn-small" data-cat="${c}">${c}</button>`
    ).join('');
  }

  function filterByCategory(cat){
    currentCategory = (cat||'').trim();
    if(!currentCategory) return render(products);
    if(currentCategory.toLowerCase()==='ofertas'){
      return render(products.filter(p => /oferta|descuento|promo/i.test(p.description||'')));
    }
    render(products.filter(p => (p.category_name||'').toLowerCase() === currentCategory.toLowerCase()));
  }

  // -------- Modales (cantidad) ----------
  const qtyModal = $('#qtyModal'), cmName=$('#cmName'), cmQty=$('#cmQty'),
        cmUnit=$('#cmUnit'), cmTotal=$('#cmTotal'), cmConfirm=$('#cmConfirm');
  let productSelected=null;

  function openQtyModal(id){
    const p = products.find(x=>x.id==id); if(!p) return;
    productSelected = p;
    cmName.textContent = p.name;
    cmUnit.textContent  = money(p.price);
    cmQty.value = 1;
    cmTotal.textContent = money(p.price);
    qtyModal.classList.remove('hidden'); qtyModal.setAttribute('aria-hidden','false');
  }
  function closeQtyModal(){ qtyModal.classList.add('hidden'); qtyModal.setAttribute('aria-hidden','true'); productSelected=null; }
  qtyModal?.addEventListener('click', e=>{ if(e.target.dataset.close) closeQtyModal(); });
  cmQty?.addEventListener('input', ()=>{ const q=Math.max(1, parseInt(cmQty.value||'1',10)); cmQty.value=q; if(productSelected) cmTotal.textContent=money(productSelected.price*q); });
  cmConfirm?.addEventListener('click', ()=>{ closeQtyModal(); });

  // -------- Modal detalles ----------
  const detailsModal=$('#detailsModal');
  const det={name:$('#detName'),price:$('#detPrice'),meta:$('#detMeta'),desc:$('#detDesc'),img:$('#detImg')};
  function openDetails(id){
    const p = products.find(x=>x.id==id); if(!p) return;
    det.name.textContent = p.name;
    det.price.textContent = money(p.price);
    det.meta.textContent  = `Categoría: ${p.category_name || '—'} · Stock: ${p.stock}`;
    det.desc.textContent  = p.description || 'Sin descripción.';
    det.img.src = p.image || PLACEHOLDER;
    detailsModal.classList.remove('hidden'); detailsModal.setAttribute('aria-hidden','false');
  }
  detailsModal?.addEventListener('click', e => { if(e.target.dataset.close){ detailsModal.classList.add('hidden'); detailsModal.setAttribute('aria-hidden','true'); } });

  // Eventos UI (usamos $ y $$ del base.html, NO los redeclaramos)
  document.addEventListener('click', e=>{
    if(e.target.matches('[data-cat]')){ e.preventDefault(); filterByCategory(e.target.dataset.cat||''); }
    const detId = e.target.dataset.det; if(detId){ e.preventDefault(); openDetails(detId); }
    const addId = e.target.dataset.add; if(addId){ e.preventDefault(); openQtyModal(addId); }
  });
  $$('.tab').forEach(b=>b.addEventListener('click',()=>{
    $$('.tab').forEach(x=>x.setAttribute('aria-selected','false'));
    b.setAttribute('aria-selected','true');
    filterByCategory(b.dataset.category||'');
  }));

  // Dispara la carga (sin redeclarar $ ni $$)
  document.addEventListener('DOMContentLoaded', loadProducts);
</script>
{% endblock %}

