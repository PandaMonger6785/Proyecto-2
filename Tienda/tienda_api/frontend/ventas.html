@@ -110,155 +110,160 @@

    lista.innerHTML = seleccionados.map(item => `
      <div class="resumen-item">
        <div>
          <strong>${item.name}</strong>
          <div class="meta">${item.qty} × ${numberFormatter.format(item.price)}</div>
        </div>
        <div>${numberFormatter.format(item.subtotal)}</div>
      </div>
    `).join('');

    const total = seleccionados.reduce((acc, it) => acc + it.subtotal, 0);
    totalSpan.textContent = total.toFixed(2);
    return seleccionados;
  }

  productos.forEach(p => {
    p.checkbox.addEventListener('change', updateResumen);
    p.qty.addEventListener('change', () => {
      if(p.qty.value <= 0) p.qty.value = 1;
      updateResumen();
    });
  });

  // ==== Compras (GET) ====
  async function loadPurchases(){
    try{
      const res = await fetch(window.API_SALES_LIST, { headers: { 'Accept':'application/json' }});
  async function loadPurchases(){
    try{
      const res = await fetch(window.API_SALES_LIST, {
        headers: { 'Accept':'application/json' },
        credentials: 'same-origin'
      });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      const rows = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);
      renderPurchases(rows);
    }catch(err){
      console.error('Error cargando compras', err);
    }
  }

  function renderPurchases(sales){
    const box = document.getElementById('purchasesList');
    if(!sales.length){
      box.innerHTML = '<p class="meta">Aún no tienes compras registradas.</p>';
      return;
    }
    const html = sales.map(sale => {
      const items = (sale.items || []).map(item => `
        <div class="purchase-item" data-id="${item.id}" data-sale="${sale.id}">
          <div>
            <strong>${item.product_name}</strong>
            <div class="meta">${item.quantity} × ${numberFormatter.format(item.unit_price)}</div>
            ${item.category_name ? `<div class="meta">Categoría: ${item.category_name}</div>` : ''}
            <div class="badge badge-${item.status}">${STATUS_LABELS[item.status] || item.status}</div>
          </div>
          <div class="purchase-actions">
            <button class="btn btn-small" data-action="received" ${item.status==='received' ? 'disabled' : ''}>Recibido</button>
            <button class="btn btn-small btn-ghost" data-action="return" ${item.status==='return_requested' ? 'disabled' : ''}>Devolución</button>
          </div>
        </div>
      `).join('');
      return `
        <article class="purchase-card">
          <header>
            <h4>Compra #${sale.id}</h4>
            <span class="meta">Total: ${numberFormatter.format(sale.total_amount)}</span>
            <span class="meta">${new Date(sale.created_at).toLocaleString('es-MX')}</span>
          </header>
          <div class="purchase-items">${items}</div>
        </article>
      `;
    }).join('');
    box.innerHTML = html;
  }

  // ==== Actualizar estado (PATCH) ====
  async function actualizarEstado(itemId, status){
    try{
      const url = saleItemDetailUrl(itemId);
      const res = await fetch(url, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken(),
          'Accept': 'application/json'
        },
        body: JSON.stringify({ status })
      const res = await fetch(url, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken(),
          'Accept': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({ status })
      });
      if(!res.ok) throw new Error('HTTP '+res.status);
      pushToast?.('Estado actualizado correctamente.', 'success');
      loadPurchases();
    }catch(err){
      console.error('Error actualizando estado', err);
      pushToast?.('No se pudo actualizar el estado.', 'danger');
    }
  }

  // ==== Crear venta (POST) ====
  document.getElementById('btnComprar').addEventListener('click', async () => {
    const seleccionados = updateResumen();
    const feedback = document.getElementById('ventasFeedback');
    feedback.innerHTML = '';

    if(!seleccionados.length){
      feedback.innerHTML = '<div class="msg-err">Selecciona al menos un producto.</div>';
      return;
    }
    if(!document.getElementById('terminos').checked){
      feedback.innerHTML = '<div class="msg-err">Debes aceptar los términos y condiciones.</div>';
      return;
    }

    // payload con product_id (lo que espera el serializer)
    const payload = {
      terms_accepted: true,
      items: seleccionados.map(item => ({
        product_id: Number(item.id),
        quantity: item.qty,
        unit_price: item.price
      }))
    };

    try{
      const res = await fetch(window.API_SALES_LIST, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken(),
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(payload)
      });
      const res = await fetch(window.API_SALES_LIST, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken(),
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      });

      if(!res.ok){
        let msg = 'Error desconocido';
        try {
          const data = await res.json();
          console.error('Errores DRF:', data);
          msg = typeof data === 'string' ? data : JSON.stringify(data);
        } catch {
          msg = await res.text();
        }
        throw new Error(msg);
      }

      pushToast?.('Compra registrada correctamente.', 'success');
      productos.forEach(p => { p.checkbox.checked = false; p.qty.value = 1; });
      document.getElementById('terminos').checked = false;
      updateResumen();
      loadPurchases();
    }catch(err){
      console.error('Error al crear la venta', err);
      feedback.innerHTML = `<div class="msg-err">${err.message}</div>`;
    }
  });

  // Cancelar