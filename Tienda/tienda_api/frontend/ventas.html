{% extends "base.html" %}
{% load static %}

{% block title %}Mis compras - TiendaExpress{% endblock %}

{% block body_class %}ventas-page{% endblock %}

{% block content %}
  <section class="hero-simple cart-hero">
    <div class="hero-inner">
      <h2>Carrito y compras</h2>
      <p>Administra los artículos seleccionados y consulta el estado de tus pedidos recientes.</p>
    </div>
  </section>

  <section class="cart-layout">
    <article class="cart-main">
      <header class="cart-header">
        <div>
          <h2>Carrito de compras</h2>
          <p class="meta">Revisa los artículos que agregaste a tu carrito desde la tienda y confirma tu compra cuando estés listo.</p>
        </div>
        <div class="cart-actions">
          <a class="btn btn-ghost" href="{% url 'tienda:home' %}">Seguir comprando</a>
          <button class="btn btn-ghost" type="button" id="btnVaciar">Vaciar carrito</button>
        </div>
      </header>

      <div id="ventasFeedback"></div>

      <div class="cart-items-list" id="cartItemsList">
        <div class="cart-empty">
          <p class="meta">Tu carrito está vacío. Busca productos en la tienda y agrégales para verlos aquí.</p>
        </div>
      </div>
    </article>

    <aside class="cart-summary">
      <div class="summary-card">
        <h3>Resumen</h3>
        <p class="meta">Tus pedidos se sincronizan automáticamente con el panel de reportes administrativos del proyecto "ReportesAdmin".</p>
        <div class="summary-row">
          <span>Total (<span id="summaryCount">0</span> productos)</span>
          <strong id="summaryTotal">$0.00</strong>
        </div>
        <button class="btn btn-primary btn-full" type="button" id="btnComprar">Registrar compra</button>
        <p class="summary-help">Al confirmar la compra, esta se registrará en tu historial y quedará disponible para reportes.</p>
      </div>
    </aside>
  </section>

  <section class="cart-recommendations">
    <h3>Productos relacionados con los artículos en tu carrito</h3>
    <div class="recommendations-grid">
      {% for product in products %}
        <article class="recommendation-card" data-id="{{ product.id }}" data-name="{{ product.name }}" data-price="{{ product.price }}">
          <div class="rec-body">
            <h4>{{ product.name }}</h4>
            {% if product.category %}
              <p class="meta">{{ product.category.name }}</p>
            {% endif %}
          </div>
          <div class="rec-footer">
            <span class="price">${{ product.price|floatformat:2 }}</span>
            <button type="button" class="btn btn-small" data-add-rec="{{ product.id }}">Agregar al carrito</button>
          </div>
        </article>
      {% empty %}
        <p class="meta">No hay productos sugeridos en este momento.</p>
      {% endfor %}
    </div>
  </section>

  <section class="compras-realizadas">
    <div class="cart-head">
      <h3>Historial de compras</h3>
      <button class="btn btn-small btn-ghost" type="button" id="btnRecargarCompras">Actualizar</button>
    </div>
    <div id="purchasesList" class="purchases-list">
      <p class="meta">Cargando historial...</p>
    </div>
  </section>
{% endblock %}

{% block extra_js %}
  {{ status_choices|json_script:"status-labels-data" }}
  {% url 'tienda:sale-list' as sale_list_url %}
  {% url 'tienda:sale-item-detail' pk=0 as sale_item_detail_url %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const STATUS_LABELS = JSON.parse(document.getElementById('status-labels-data')?.textContent || '{}');
      const API_SALES_LIST = "{{ sale_list_url }}";
      const SALE_ITEM_TEMPLATE = "{{ sale_item_detail_url }}";

      const cartItemsList = document.getElementById('cartItemsList');
      const summaryCount = document.getElementById('summaryCount');
      const summaryTotal = document.getElementById('summaryTotal');
      const feedback = document.getElementById('ventasFeedback');
      const btnComprar = document.getElementById('btnComprar');
      const btnVaciar = document.getElementById('btnVaciar');
      const btnRecargar = document.getElementById('btnRecargarCompras');
      const purchasesList = document.getElementById('purchasesList');
      const defaultCustomerName = "{{ user.get_full_name|default:user.username|default:'Cliente'|escapejs }}";

      const recommendedContainer = document.querySelector('.recommendations-grid');

      let cartItems = window.CartManager?.getItems() || [];

      const numberFormatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });

      function saleItemDetailUrl(id){
        return SALE_ITEM_TEMPLATE.replace(/0\/$/, `${id}/`);
      }

      function getCsrfToken(){
        return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
      }

      function syncHeader(){
        if(typeof window.CartManager?.setItems === 'function'){
          window.CartManager.setItems(cartItems);
          cartItems = window.CartManager.getItems();
        }
      }

      function clearFeedback(){
        if(feedback) feedback.innerHTML = '';
      }

      function showFeedback(message, variant='info'){
        if(!feedback) return;
        const variants = {
          success: 'msg-ok',
          danger: 'msg-err',
          warning: 'msg-warn',
          info: 'msg-info'
        };
        const cls = variants[variant] || variants.info;
        feedback.innerHTML = `<div class="${cls}">${message}</div>`;
      }

      function setButtonLoading(button, loading, loadingText='Procesando...'){
        if(!button) return;
        if(loading){
          if(!button.dataset.prevText) button.dataset.prevText = button.textContent;
          button.textContent = loadingText;
          button.setAttribute('disabled', 'disabled');
        }else{
          const text = button.dataset.prevText || button.textContent;
          button.textContent = text;
          button.removeAttribute('disabled');
          delete button.dataset.prevText;
        }
      }

      function renderCart(){
        if(!cartItemsList) return;

        if(!cartItems.length){
          cartItemsList.innerHTML = `
            <div class="cart-empty">
              <strong>Tu carrito está vacío</strong>
              <p class="meta">Explora la tienda y agrega productos para registrarlos aquí.</p>
            </div>
          `;
          summaryCount.textContent = '0';
          summaryTotal.textContent = numberFormatter.format(0);
          btnComprar?.setAttribute('disabled', 'disabled');
          btnVaciar?.setAttribute('disabled', 'disabled');
          return;
        }

        const html = cartItems.map(item => `
          <article class="cart-line" data-id="${item.id}">
            <div class="cart-line-info">
              <strong>${item.name}</strong>
              <div class="meta">${numberFormatter.format(item.price)} por unidad</div>
              <button type="button" class="cart-remove" data-remove="${item.id}">Eliminar</button>
            </div>
            <div class="cart-line-actions">
              <div class="qty-control">
                <button type="button" class="qty-btn" data-action="dec" aria-label="Disminuir">−</button>
                <input type="number" min="1" value="${item.quantity}" inputmode="numeric">
                <button type="button" class="qty-btn" data-action="inc" aria-label="Aumentar">+</button>
              </div>
              <div class="cart-line-subtotal">${numberFormatter.format(item.quantity * item.price)}</div>
            </div>
          </article>
        `).join('');

        cartItemsList.innerHTML = html;
        const total = cartItems.reduce((acc, it) => acc + (Number(it.price) || 0) * (Number(it.quantity) || 0), 0);
        const count = cartItems.reduce((acc, it) => acc + (Number(it.quantity) || 0), 0);
        summaryCount.textContent = count.toString();
        summaryTotal.textContent = numberFormatter.format(total);
        btnComprar?.removeAttribute('disabled');
        btnVaciar?.removeAttribute('disabled');
      }

      function refreshCart(){
        cartItems = window.CartManager?.getItems() || [];
        renderCart();
      }

      function updateQuantity(id, qty){
        qty = Number(qty);
        if(Number.isNaN(qty) || qty <= 0) qty = 1;
        cartItems = cartItems.map(item => item.id === id ? { ...item, quantity: qty } : item);
        syncHeader();
        renderCart();
      }

      cartItemsList?.addEventListener('click', (e) => {
        const line = e.target.closest('.cart-line');
        if(!line) return;
        const id = Number(line.dataset.id);
        if(!id) return;

        if(e.target.classList.contains('cart-remove')){
          cartItems = cartItems.filter(item => item.id !== id);
          syncHeader();
          renderCart();
          return;
        }

        if(e.target.classList.contains('qty-btn')){
          const input = line.querySelector('input[type="number"]');
          if(!input) return;
          let value = Number(input.value) || 1;
          if(e.target.dataset.action === 'inc') value += 1;
          if(e.target.dataset.action === 'dec') value = Math.max(1, value - 1);
          input.value = value;
          updateQuantity(id, value);
        }
      });

      cartItemsList?.addEventListener('change', (e) => {
        const input = e.target;
        if(!(input instanceof HTMLInputElement)) return;
        const line = input.closest('.cart-line');
        if(!line) return;
        const id = Number(line.dataset.id);
        if(!id) return;
        updateQuantity(id, input.value);
      });

      btnVaciar?.addEventListener('click', () => {
        cartItems = [];
        syncHeader();
        renderCart();
      });

      recommendedContainer?.addEventListener('click', (e) => {
        const button = e.target.closest('button[data-add-rec]');
        if(!button) return;
        const card = button.closest('.recommendation-card');
        if(!card) return;
        const id = Number(card.dataset.id);
        if(!id) return;
        const name = card.dataset.name || 'Producto';
        const price = Number(card.dataset.price) || 0;
        window.CartManager?.add({ id, name, price, quantity: 1 });
        refreshCart();
      });

      refreshCart();

      async function loadPurchases(){
        if(purchasesList){
          purchasesList.innerHTML = '<p class="meta">Cargando historial...</p>';
        }
        btnRecargar?.setAttribute('disabled', 'disabled');
        try{
          const res = await fetch(API_SALES_LIST, { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' });
          if(!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          const rows = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);
          renderPurchases(rows);
        }catch(err){
          console.error('Error cargando compras', err);
          if(purchasesList){
            purchasesList.innerHTML = '<p class="msg-err">No se pudieron cargar tus compras.</p>';
          }
        }finally{
          btnRecargar?.removeAttribute('disabled');
        }
      }

      function resolveSaleStatus(sale){
        if(sale.status) return sale.status;
        const statuses = new Set((sale.items || []).map(item => item.status).filter(Boolean));
        if(statuses.has('return_requested')) return 'return_requested';
        if(statuses.size === 0) return 'pending';
        if(statuses.size === 1) return Array.from(statuses)[0];
        if(statuses.has('pending')) return 'pending';
        if(statuses.has('received')) return 'received';
        return Array.from(statuses)[0];
      }

      function getStatusLabel(status){
        return STATUS_LABELS[status] || 'Estado desconocido';
      }

      function renderPurchases(sales){
        if(!purchasesList) return;
        if(!sales.length){
          purchasesList.innerHTML = '<p class="meta">Aún no tienes compras registradas.</p>';
          return;
        }
        const html = sales.map(sale => {
          const saleStatus = resolveSaleStatus(sale);
          const saleStatusClass = saleStatus ? ` badge-${saleStatus}` : '';
          const saleStatusLabel = getStatusLabel(saleStatus);
          const totalAmount = Number(sale.total_amount ?? 0);
          const computedTotal = (sale.items || []).reduce((acc, item) => {
            const price = Number(item.price ?? item.unit_price ?? 0);
            const qty = Number(item.quantity) || 0;
            return acc + price * qty;
          }, 0);
          const saleTotalValue = totalAmount > 0 ? totalAmount : computedTotal;
          const saleTotal = numberFormatter.format(saleTotalValue);

          const items = (sale.items || []).map(item => {
            const itemName = item.name || item.product_name || 'Producto';
            const itemPrice = Number(item.price ?? item.unit_price ?? 0);
            const quantity = Number(item.quantity) || 0;
            const subtotal = numberFormatter.format(quantity * itemPrice);
            const itemStatus = item.status || saleStatus || 'pending';
            const itemStatusClass = itemStatus ? ` badge-${itemStatus}` : '';
            const itemStatusLabel = getStatusLabel(itemStatus);

            const actions = [];
            if(item.status === 'pending'){
              actions.push('<button class="btn btn-small btn-primary" type="button" data-action="received">Marcar recibido</button>');
              actions.push('<button class="btn btn-small btn-danger" type="button" data-action="return">Solicitar devolución</button>');
            }else if(item.status === 'received'){
              actions.push('<button class="btn btn-small btn-danger" type="button" data-action="return">Solicitar devolución</button>');
            }

            const actionsHtml = actions.length ? `<div class="purchase-actions">${actions.join('')}</div>` : '';

            return `
              <div class="purchase-item" data-id="${item.id}" data-sale="${sale.id}">
                <div>
                  <strong>${itemName}</strong>
                  <div class="meta">${quantity} × ${numberFormatter.format(itemPrice)}</div>
                  <span class="purchase-status${itemStatusClass}">${itemStatusLabel}</span>
                </div>
                <div>
                  <div class="purchase-subtotal">${subtotal}</div>
                  ${actionsHtml}
                </div>
              </div>
            `;
          }).join('');
          return `
            <div class="purchase" data-id="${sale.id}">
              <div class="purchase-header">
                <div class="purchase-meta">
                  <strong>${sale.created_at}</strong>
                  <span class="purchase-total">${saleTotal}</span>
                </div>
                <span class="purchase-status${saleStatusClass}">${saleStatusLabel}</span>
              </div>
              <div class="purchase-items">${items}</div>
            </div>
          `;
        }).join('');
        purchasesList.innerHTML = html;
      }

      async function actualizarEstado(itemId, status){
        try{
          const url = saleItemDetailUrl(itemId);
          const res = await fetch(url, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCsrfToken(),
              'Accept': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ status })
          });
          if(!res.ok) throw new Error('HTTP '+res.status);
          window.pushToast?.('Estado actualizado correctamente.', 'success');
          loadPurchases();
        }catch(err){
          console.error('Error actualizando estado', err);
          window.pushToast?.('No se pudo actualizar el estado.', 'danger');
        }
      }

      async function registrarCompra(){
        if(!cartItems.length){
          showFeedback('No hay productos en tu carrito para registrar la compra.', 'warning');
          return;
        }

        const payload = {
          customer_name: defaultCustomerName || 'Cliente',
          terms_accepted: true,
          items: cartItems.map(item => ({
            product_id: Number(item.id),
            quantity: Number(item.quantity) || 1,
            unit_price: Number(item.price) || 0
          }))
        };

        clearFeedback();
        setButtonLoading(btnComprar, true, 'Registrando...');

        try{
          const res = await fetch(API_SALES_LIST, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCsrfToken(),
              'Accept': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });

          if(!res.ok){
            let errorMessage = 'No se pudo registrar la compra.';
            try{
              const data = await res.json();
              if(typeof data === 'string'){
                errorMessage = data;
              }else if(data && typeof data === 'object'){
                const details = Object.entries(data)
                  .map(([, value]) => Array.isArray(value) ? value.join(' ') : String(value))
                  .join(' ');
                if(details.trim()) errorMessage = details;
              }
            }catch(parseErr){
              console.error('No se pudo interpretar el error del servidor', parseErr);
            }
            throw new Error(errorMessage);
          }

          await res.json();
          window.pushToast?.('Compra registrada correctamente.', 'success');
          showFeedback('Compra registrada correctamente.', 'success');
          window.CartManager?.clear();
          cartItems = [];
          renderCart();
          loadPurchases();
        }catch(err){
          console.error('Error registrando compra', err);
          showFeedback(err.message || 'No se pudo registrar la compra.', 'danger');
        }finally{
          setButtonLoading(btnComprar, false);
        }
      }

      btnComprar?.addEventListener('click', registrarCompra);

      btnRecargar?.addEventListener('click', (e) => {
        e.preventDefault();
        loadPurchases();
      });

      purchasesList?.addEventListener('click', (e) => {
        const actionBtn = e.target.closest('button[data-action]');
        if(!actionBtn) return;
        const item = actionBtn.closest('.purchase-item');
        if(!item) return;
        const itemId = Number(item.dataset.id);
        if(!itemId) return;

        let newStatus = null;
        if(actionBtn.dataset.action === 'received') newStatus = 'received';
        if(actionBtn.dataset.action === 'return') newStatus = 'return_requested';
        if(!newStatus) return;

        actionBtn.setAttribute('disabled', 'disabled');
        actualizarEstado(itemId, newStatus)
          .catch(() => {})

          .finally(() => actionBtn.removeAttribute('disabled'));
      });

      loadPurchases();
    });
  </script>
{% endblock %}
