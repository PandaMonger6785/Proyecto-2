{% extends "base.html" %}
{% load static %}

{% block title %}Mis compras - TiendaExpress{% endblock %}

{% block content %}
  <section class="cart-layout">
    <article class="cart-main">
      <header class="cart-header">
        <div>
          <h2>Carrito de compras</h2>
          <p class="meta">Revisa los artículos que agregaste desde la tienda y confirma tu compra cuando estés listo.</p>
        </div>
        <div class="cart-actions">
          <a class="btn btn-ghost" href="{% url 'tienda:home' %}">Seguir comprando</a>
          <button class="btn btn-ghost" type="button" id="btnVaciar">Vaciar carrito</button>
        </div>
      </header>

      <div id="ventasFeedback"></div>

      <div class="cart-items-list" id="cartItemsList">
        <div class="cart-empty">
          <p class="meta">Tu carrito está vacío. Busca productos en el inicio y agrégales para verlos aquí.</p>
        </div>
      </div>
    </article>

    <aside class="cart-summary">
      <div class="summary-card">
        <h3>Resumen</h3>
        <p class="meta">Tus pedidos se sincronizan automáticamente con el panel de reportes administrativos alojado en el proyecto "ReportesAdmin".</p>
        <div class="summary-row">
          <span>Total (<span id="summaryCount">0</span> productos)</span>
          <strong id="summaryTotal">$0.00</strong>
        </div>
        <button class="btn btn-primary btn-full" type="button" id="btnComprar">Registrar compra</button>
        <p class="summary-help">Al confirmar la compra, esta se registrará en tu historial y estará disponible para reportes.</p>
      </div>
    </aside>
  </section>

  <section class="cart-recommendations">
    <h3>Relacionado con los artículos de tu carrito</h3>
    <div class="recommendations-grid">
      {% for product in products %}
        <article class="recommendation-card" data-id="{{ product.id }}" data-name="{{ product.name }}" data-price="{{ product.price }}">
          <div class="rec-body">
            <h4>{{ product.name }}</h4>
            {% if product.category %}
              <p class="meta">{{ product.category.name }}</p>
            {% endif %}
          </div>
          <div class="rec-footer">
            <span class="price">${{ product.price|floatformat:2 }}</span>
            <button type="button" class="btn btn-small" data-add-rec="{{ product.id }}">Agregar al carrito</button>
          </div>
        </article>
      {% empty %}
        <p class="meta">No hay productos sugeridos en este momento.</p>
      {% endfor %}
    </div>
  </section>

  <section class="compras-realizadas">
    <div class="cart-head">
      <h3>Historial de compras</h3>
      <button class="btn btn-small btn-ghost" type="button" id="btnRecargarCompras">Actualizar</button>
    </div>
    <div id="purchasesList" class="purchases-list">
      <p class="meta">Cargando historial...</p>
    </div>
  </section>
{% endblock %}

{% block extra_js %}
  {{ status_choices|json_script:"status-labels-data" }}
  {% url 'tienda:sale-list' as sale_list_url %}
  {% url 'tienda:sale-item-detail' pk=0 as sale_item_detail_url %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const STATUS_LABELS = JSON.parse(document.getElementById('status-labels-data')?.textContent || '{}');
      const API_SALES_LIST = "{{ sale_list_url }}";
      const SALE_ITEM_TEMPLATE = "{{ sale_item_detail_url }}";

      const cartItemsList = document.getElementById('cartItemsList');
      const summaryCount = document.getElementById('summaryCount');
      const summaryTotal = document.getElementById('summaryTotal');
      const feedback = document.getElementById('ventasFeedback');
      const btnComprar = document.getElementById('btnComprar');
      const btnVaciar = document.getElementById('btnVaciar');
      const btnRecargar = document.getElementById('btnRecargarCompras');
      const purchasesList = document.getElementById('purchasesList');

      const recommendedContainer = document.querySelector('.recommendations-grid');

      let cartItems = window.CartManager?.getItems() || [];

      const numberFormatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });

      function saleItemDetailUrl(id){
        return SALE_ITEM_TEMPLATE.replace(/0\/$/, `${id}/`);
      }

      function getCsrfToken(){
        return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
      }

      function syncHeader(){
        if(typeof window.CartManager?.setItems === 'function'){
          window.CartManager.setItems(cartItems);
          cartItems = window.CartManager.getItems();
        }
      }

      function renderCart(){
        if(!cartItemsList) return;

        if(!cartItems.length){
          cartItemsList.innerHTML = `
            <div class="cart-empty">
              <strong>Tu carrito está vacío</strong>
              <p class="meta">Explora la tienda y agrega productos para registrarlos aquí.</p>
            </div>
          `;
          summaryCount.textContent = '0';
          summaryTotal.textContent = numberFormatter.format(0);
          btnComprar?.setAttribute('disabled', 'disabled');
          btnVaciar?.setAttribute('disabled', 'disabled');
          return;
        }

        const html = cartItems.map(item => `
          <article class="cart-line" data-id="${item.id}">
            <div class="cart-line-info">
              <strong>${item.name}</strong>
              <div class="meta">${numberFormatter.format(item.price)} por unidad</div>
              <button type="button" class="cart-remove" data-remove="${item.id}">Eliminar</button>
            </div>
            <div class="cart-line-actions">
              <div class="qty-control">
                <button type="button" class="qty-btn" data-action="dec" aria-label="Disminuir">−</button>
                <input type="number" min="1" value="${item.quantity}" inputmode="numeric">
                <button type="button" class="qty-btn" data-action="inc" aria-label="Aumentar">+</button>
              </div>
              <div class="cart-line-subtotal">${numberFormatter.format(item.quantity * item.price)}</div>
            </div>
          </article>
        `).join('');

        cartItemsList.innerHTML = html;
        const total = cartItems.reduce((acc, it) => acc + (Number(it.price) || 0) * (Number(it.quantity) || 0), 0);
        const count = cartItems.reduce((acc, it) => acc + (Number(it.quantity) || 0), 0);
        summaryCount.textContent = count.toString();
        summaryTotal.textContent = numberFormatter.format(total);
        btnComprar?.removeAttribute('disabled');
        btnVaciar?.removeAttribute('disabled');
      }

      function refreshCart(){
        cartItems = window.CartManager?.getItems() || [];
        renderCart();
      }

      function updateQuantity(id, qty){
        qty = Number(qty);
        if(Number.isNaN(qty) || qty <= 0) qty = 1;
        cartItems = cartItems.map(item => item.id === id ? { ...item, quantity: qty } : item);
        syncHeader();
        renderCart();
      }

      cartItemsList?.addEventListener('click', (e) => {
        const line = e.target.closest('.cart-line');
        if(!line) return;
        const id = Number(line.dataset.id);
        if(!id) return;

        if(e.target.classList.contains('cart-remove')){
          cartItems = cartItems.filter(item => item.id !== id);
          syncHeader();
          renderCart();
          return;
        }

        if(e.target.classList.contains('qty-btn')){
          const input = line.querySelector('input[type="number"]');
          if(!input) return;
          let value = Number(input.value) || 1;
          if(e.target.dataset.action === 'inc') value += 1;
          if(e.target.dataset.action === 'dec') value = Math.max(1, value - 1);
          input.value = value;
          updateQuantity(id, value);
        }
      });

      cartItemsList?.addEventListener('change', (e) => {
        const input = e.target;
        if(!(input instanceof HTMLInputElement)) return;
        const line = input.closest('.cart-line');
        if(!line) return;
        const id = Number(line.dataset.id);
        if(!id) return;
        updateQuantity(id, input.value);
      });

      btnVaciar?.addEventListener('click', () => {
        cartItems = [];
        syncHeader();
        renderCart();
      });

      recommendedContainer?.addEventListener('click', (e) => {
        const button = e.target.closest('button[data-add-rec]');
        if(!button) return;
        const card = button.closest('.recommendation-card');
        if(!card) return;
        const id = Number(card.dataset.id);
        if(!id) return;
        const name = card.dataset.name || 'Producto';
        const price = Number(card.dataset.price) || 0;
        window.CartManager?.add({ id, name, price, quantity: 1 });
        refreshCart();
      });

      refreshCart();

      async function loadPurchases(){
        if(purchasesList){
          purchasesList.innerHTML = '<p class="meta">Cargando historial...</p>';
        }
        try{
          const res = await fetch(API_SALES_LIST, { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' });
          if(!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          const rows = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);
          renderPurchases(rows);
        }catch(err){
          console.error('Error cargando compras', err);
          if(purchasesList){
            purchasesList.innerHTML = '<p class="msg-err">No se pudieron cargar tus compras.</p>';
          }
        }
      }

      function renderPurchases(sales){
        if(!purchasesList) return;
        if(!sales.length){
          purchasesList.innerHTML = '<p class="meta">Aún no tienes compras registradas.</p>';
          return;
        }
        const html = sales.map(sale => {
          const items = (sale.items || []).map(item => `
            <div class="purchase-item" data-id="${item.id}" data-sale="${sale.id}">
              <div>
                <strong>${item.name}</strong>
                <div class="meta">${item.quantity} × ${numberFormatter.format(item.price)}</div>
              </div>
              <div>${numberFormatter.format(item.quantity * item.price)}</div>
            </div>
          `).join('');
          return `
            <div class="purchase" data-id="${sale.id}">
              <div class="purchase-header">
                <strong>${sale.created_at}</strong>
                <div class="meta">${STATUS_LABELS[sale.status] || 'Estado desconocido'}</div>
              </div>
              <div class="purchase-items">${items}</div>
            </div>
          `;
        }).join('');
        purchasesList.innerHTML = html;
      }

      async function actualizarEstado(itemId, status){
        try{
          const url = saleItemDetailUrl(itemId);
          const res = await fetch(url, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCsrfToken(),
              'Accept': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ status })
          });
          if(!res.ok) throw new Error('HTTP '+res.status);
          window.pushToast?.('Estado actualizado correctamente.', 'success');
          loadPurchases();
        }catch(err){
          console.error('Error actualizando estado', err);
          window.pushToast?.('No se pudo actualizar el estado.', 'danger');
        }
      }

      btnComprar?.addEventListener('click', async () => {
        const seleccionados = window.CartManager?.getItems() || [];
        feedback.innerHTML = '';

        if(!seleccionados.length){
          feedback.innerHTML = '<div class="msg-err">Tu carrito está vacío.</div>';
          return;
        }

        const payload = {
          terms_accepted: true,
          items: seleccionados.map(item => ({
            product_id: Number(item.id),
            quantity: item.quantity,
            unit_price: item.price
          }))
        };

        try{
          const res = await fetch(API_SALES_LIST, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCsrfToken(),
              'Accept': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });

          if(!res.ok){
            let message = 'No se pudo registrar la compra.';
            try{
              const data = await res.json();
              message = typeof data === 'string' ? data : JSON.stringify(data);
            }catch{ message = await res.text(); }
            throw new Error(message);
          }

          window.pushToast?.('Compra registrada correctamente.', 'success');
          cartItems = [];
          syncHeader();
          renderCart();
          loadPurchases();
        }catch(err){
          console.error('Error al crear la venta', err);
          feedback.innerHTML = `<div class="msg-err">${err.message}</div>`;
        }
      });

      purchasesList?.addEventListener('click', (e) => {
        const action = e.target.dataset.action;
        if(!action) return;
        const itemEl = e.target.closest('.purchase-item');
        if(!itemEl) return;
        const itemId = Number(itemEl.dataset.id);
        if(!itemId) return;
        if(action === 'received'){
          actualizarEstado(itemId, 'received');
        }else if(action === 'return'){
          actualizarEstado(itemId, 'return_requested');
        }
      });

      btnRecargar?.addEventListener('click', loadPurchases);
      loadPurchases();
    });
  </script>
{% endblock %}
