{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Tienda{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}?v=21">
  {% block extra_head %}{% endblock %}
</head>
<body class="{% block body_class %}{% endblock %}">
  <header class="top">
    <div class="brand"><a href="{% url 'tienda:home' %}">TiendaExpress</a></div>

    <div class="search">
      <input type="search" id="q" placeholder="Buscar productos..." aria-label="Buscar productos">
    </div>

    <nav class="main-nav">
      <ul>
        <li><a href="{% url 'tienda:home' %}" class="nav-link">Inicio</a></li>
        <li><a href="{% url 'tienda:ventas' %}" class="nav-link">Ventas</a></li>
        <li><a href="{% url 'tienda:contacto' %}" class="nav-link">Contacto</a></li>

        <li class="has-dd" id="catsMenu">
          <button type="button" class="dd-toggle" aria-expanded="false">Categorías</button>
          <div class="dropdown" id="catDropdown">
            <button type="button" class="dropdown-action" data-cat="">Todas</button>
            <hr>
            <div id="catList" class="dropdown-list">
              <div class="meta">Cargando...</div>
            </div>
          </div>
        </li>

        <li class="has-dd">
          <button type="button" class="dd-toggle">Ayuda</button>
          <div class="dropdown">
            <button type="button" class="dropdown-action" data-show-modal="envio">Información de envío</button>
            <button type="button" class="dropdown-action" data-show-modal="soporte">Soporte 24/7</button>
            <button type="button" class="dropdown-action" data-show-modal="promo">Promociones del mes</button>
          </div>
        </li>

        <li class="has-dd">
          <button type="button" class="dd-toggle">
            {% if user.is_authenticated %}{{ user.username }}{% else %}Cuenta{% endif %}
            <span class="badge-cart" id="cartBadge">0</span>
          </button>
          <div class="dropdown right cart-dropdown">
            {% if user.is_authenticated %}
              <div class="account-inner">
                <div class="account-title">Hola, {{ user.get_full_name|default:user.username }}</div>
                <a class="dropdown-action" href="{% url 'tienda:ventas' %}">Mis compras</a>
                <hr>
                <a class="btn btn-ghost" href="{% url 'tienda:logout' %}">Cerrar sesión</a>
              </div>
              <hr>
            {% else %}
              <div class="account-inner">
                <p class="account-meta">Inicia sesión para gestionar tus pedidos.</p>
                <div class="account-actions">
                  <a class="btn btn-primary" href="{% url 'tienda:login' %}">Iniciar sesión</a>
                  <a class="btn btn-ghost" href="{% url 'tienda:signup' %}">Crear cuenta</a>
                </div>
              </div>
              <hr>
            {% endif %}
            <div class="cart-head"><strong>Carrito</strong></div>
            <div class="cart-items" id="cartItems">
              <div class="meta">Tu carrito está vacío.</div>
            </div>
            <div class="cart-foot">
              <span class="cart-total" id="cartTotal">Total: $0.00</span>
              <a class="btn btn-primary" href="{% url 'tienda:ventas' %}">Ir a ventas</a>
            </div>
          </div>
        </li>
      </ul>
    </nav>
  </header>

  <main class="page-content">
    {% block content %}{% endblock %}
  </main>

  <!-- Modal genérico -->
  <div id="modalLayer" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="1"></div>
    <article class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header class="modal-header">
        <h3 id="modalTitle">Aviso importante</h3>
        <button type="button" class="btn btn-ghost" data-close="1">Cerrar</button>
      </header>
      <div id="modalContent"></div>
    </article>
  </div>

  <!-- Toasts -->
  <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <script>
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    const $  = (sel, ctx=document) => ctx.querySelector(sel);

    // Modales
    const modalMessages = {
      envio:  { title: 'Información de envío', text: 'Envíos gratis a todo México en compras superiores a $999 MXN.' },
      soporte:{ title: 'Soporte 24/7',         text: 'Nuestro equipo responde en menos de 5 minutos mediante chat en vivo.' },
      promo:  { title: 'Promoción del mes',    text: 'Obtén 20% de descuento en accesorios seleccionados usando el cupón PROMO20.' }
    };
    function showModal(type){
      const modal = $('#modalLayer'); if(!modal) return;
      const data = modalMessages[type]; if(!data) return;
      $('#modalTitle').textContent  = data.title;
      $('#modalContent').textContent= data.text;
      modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false');
    }
    function hideModal(){ const m=$('#modalLayer'); m.classList.add('hidden'); m.setAttribute('aria-hidden','true'); }
    document.addEventListener('click', (e) => {
      if (e.target.dataset.showModal) showModal(e.target.dataset.showModal);
      if (e.target.dataset.close) hideModal();
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideModal(); });

    // Toasts
    function pushToast(message, variant='info', timeout=4000){
      const box = document.createElement('div');
      box.className = `toast toast-${variant}`;
      box.textContent = message;
      $('#toastContainer')?.appendChild(box);
      requestAnimationFrame(()=> box.classList.add('show'));
      setTimeout(() => { box.classList.remove('show'); setTimeout(() => box.remove(), 300); }, timeout);
    }
    document.addEventListener('DOMContentLoaded', () => {
      pushToast('¡Bienvenido a TiendaExpress!', 'success', 4500);
      setTimeout(()=>pushToast('Revisa nuestras promociones del mes.', 'info'), 5200);
      setTimeout(()=>pushToast('¿Necesitas ayuda? Chat 24/7.', 'warning'), 9000);
    });
  </script>

  <script src="{% static 'js/main.js' %}?v=2"></script>

  {% block extra_js %}{% endblock %}
</body>
</html>
